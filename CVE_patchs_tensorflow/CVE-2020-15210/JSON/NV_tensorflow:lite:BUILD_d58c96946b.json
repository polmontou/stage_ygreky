"load(\"//tensorflow:tensorflow.bzl\", \"if_not_windows\", \"tf_cc_test\")\nload(\"//tensorflow/lite:build_def.bzl\", \"tflite_cc_shared_object\", \"tflite_copts\")\nload(\"//tensorflow/lite:special_rules.bzl\", \"tflite_portable_test_suite\")\nload(\"//tensorflow:tensorflow.bzl\", \"get_compatible_with_portable\")\n\npackage(\n    default_visibility = [\"//visibility:public\"],\n    licenses = [\"notice\"],  # Apache 2.0\n)\n\nexports_files(glob([\n    \"testdata/*.bin\",\n    \"testdata/*.pb\",\n    \"testdata/*.tflite\",\n    \"testdata/*.csv\",\n    \"models/testdata/*\",\n]))\n\nconfig_setting(\n    name = \"gemmlowp_profiling\",\n    values = {\n        \"copt\": \"-DGEMMLOWP_PROFILING\",\n    },\n)\n\nconfig_setting(\n    name = \"mips\",\n    values = {\n        \"cpu\": \"mips\",\n    },\n)\n\nconfig_setting(\n    name = \"mips64\",\n    values = {\n        \"cpu\": \"mips64\",\n    },\n)\n\nconfig_setting(\n    name = \"tf_lite_static_memory\",\n    values = {\n        \"copt\": \"-DTF_LITE_STATIC_MEMORY\",\n        \"cpu\": \"k8\",\n    },\n)\n\nTFLITE_DEFAULT_COPTS = if_not_windows([\n    \"-Wall\",\n    \"-Wno-comment\",\n    \"-Wno-extern-c-compat\",\n])\n\nFRAMEWORK_LIB_HDRS = [\n    \"allocation.h\",\n    \"context.h\",\n    \"context_util.h\",\n    \"core/macros.h\",\n    \"core/subgraph.h\",\n    \"error_reporter.h\",\n    \"graph_info.h\",\n    \"interpreter.h\",\n    \"model.h\",\n    \"model_builder.h\",\n    \"interpreter_builder.h\",\n    \"mutable_op_resolver.h\",\n    \"op_resolver.h\",\n    \"optional_debug_tools.h\",\n    \"stderr_reporter.h\",\n]\n\ncc_library(\n    name = \"version\",\n    hdrs = [\"version.h\"],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS,\n    # Note that we only use the header defines from :version_lib.\n    deps = [\"//tensorflow/core:version_lib\"],\n)\n\n# TODO(b/128420794): Migrate clients to use :version directly.\nalias(\n    name = \"schema_fbs_version\",\n    actual = \":version\",\n    # avoid_dep tells build_cleaner to not use schema_fbs_version.\n    tags = [\"avoid_dep\"],\n)\n\ncc_library(\n    name = \"arena_planner\",\n    srcs = [\"arena_planner.cc\"],\n    hdrs = [\"arena_planner.h\"],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS,\n    deps = [\n        \":graph_info\",\n        \":memory_planner\",\n        \":simple_memory_arena\",\n        \":util\",\n        \"//tensorflow/lite/c:common\",\n    ],\n)\n\ncc_test(\n    name = \"arena_planner_test\",\n    size = \"small\",\n    srcs = [\"arena_planner_test.cc\"],\n    tags = [\n        \"tflite_not_portable_android\",\n    ],\n    deps = [\n        \":arena_planner\",\n        \"//tensorflow/core:tflite_portable_logging\",\n        \"//tensorflow/lite/testing:util\",\n        \"@com_google_googletest//:gtest\",\n    ],\n)\n\n# Main library. No ops are included here.\n# TODO(aselle): Resolve problems preventing C99 usage.\ncc_library(\n    name = \"context\",\n    hdrs = [\"context.h\"],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS,\n    deps = [\"//tensorflow/lite/c:common\"],\n)\n\ncc_library(\n    name = \"external_cpu_backend_context\",\n    srcs = [\"external_cpu_backend_context.cc\"],\n    hdrs = [\"external_cpu_backend_context.h\"],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS,\n    deps = [\n        \"//tensorflow/lite/c:common\",\n    ],\n)\n\ncc_library(\n    name = \"graph_info\",\n    hdrs = [\"graph_info.h\"],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS,\n    deps = [\"//tensorflow/lite/c:common\"],\n)\n\ncc_library(\n    name = \"memory_planner\",\n    hdrs = [\"memory_planner.h\"],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS,\n    deps = [\"//tensorflow/lite/c:common\"],\n)\n\ncc_library(\n    name = \"simple_memory_arena\",\n    srcs = [\"simple_memory_arena.cc\"],\n    hdrs = [\"simple_memory_arena.h\"],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS,\n    deps = [\"//tensorflow/lite/c:common\"],\n)\n\ncc_library(\n    name = \"builtin_op_data\",\n    hdrs = [\n        \"builtin_op_data.h\",\n    ],\n    deps = [\"//tensorflow/lite/c:common\"],\n)\n\ncc_library(\n    name = \"kernel_api\",\n    hdrs = [\n        \"builtin_op_data.h\",\n        \"builtin_ops.h\",\n        \"context_util.h\",\n    ],\n    compatible_with = get_compatible_with_portable(),\n    deps = [\"//tensorflow/lite/c:common\"],\n)\n\nexports_files([\"builtin_ops.h\"])\n\ncc_library(\n    name = \"string\",\n    hdrs = [\n        \"string_type.h\",\n    ],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS,\n)\n\ncc_library(\n    name = \"allocation\",\n    srcs = [\n        \"allocation.cc\",\n    ] + select({\n        \"//tensorflow:android\": [\n            \"mmap_allocation.cc\",\n        ],\n        \"//tensorflow:windows\": [\n            \"mmap_allocation_disabled.cc\",\n        ],\n        \"//conditions:default\": [\n            \"mmap_allocation.cc\",\n        ],\n    }),\n    hdrs = [\n        \"allocation.h\",\n    ],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS,\n    deps = [\n        \":string\",\n        \"//tensorflow/lite/c:common\",\n        \"//tensorflow/lite/core/api\",\n    ],\n)\n\ncc_library(\n    name = \"framework_lib\",\n    srcs = [\n        \"core/subgraph.cc\",\n        \"graph_info.cc\",\n        \"interpreter.cc\",\n        \"interpreter_builder.cc\",\n        \"model_builder.cc\",\n        \"mutable_op_resolver.cc\",\n        \"optional_debug_tools.cc\",\n        \"stderr_reporter.cc\",\n    ],\n    hdrs = FRAMEWORK_LIB_HDRS,\n    compatible_with = get_compatible_with_portable(),\n    copts = tflite_copts() + TFLITE_DEFAULT_COPTS,\n    visibility = [\n        \"//tensorflow/lite:__subpackages__\",\n    ],\n    deps = [\n        \":allocation\",\n        \":arena_planner\",\n        \":external_cpu_backend_context\",\n        \":graph_info\",\n        \":memory_planner\",\n        \":minimal_logging\",\n        \":shared_library\",\n        \":simple_memory_arena\",\n        \":string\",\n        \":type_to_tflitetype\",\n        \":util\",\n        \":version\",\n        \"//tensorflow/lite/c:common\",\n        \"//tensorflow/lite/core/api\",\n        \"//tensorflow/lite/delegates:status\",\n        \"//tensorflow/lite/delegates/nnapi:nnapi_delegate\",\n        \"//tensorflow/lite/experimental/resource\",\n        \"//tensorflow/lite/kernels/internal:compatibility\",\n        \"//tensorflow/lite/nnapi:nnapi_implementation\",\n        \"//tensorflow/lite/profiling:platform_profiler\",\n        \"//tensorflow/lite/schema:schema_fbs\",\n    ],\n    alwayslink = 1,\n)\n\n# TODO(ahentz): investigate dependency on gemm_support requiring usage of tf_copts.\ncc_library(\n    name = \"framework\",\n    srcs = [\n    ],\n    hdrs = FRAMEWORK_LIB_HDRS,\n    compatible_with = get_compatible_with_portable(),\n    copts = tflite_copts() + TFLITE_DEFAULT_COPTS,\n    deps = [\n        \":allocation\",\n        \":arena_planner\",\n        \":external_cpu_backend_context\",\n        \":framework_lib\",\n        \":graph_info\",\n        \":memory_planner\",\n        \":minimal_logging\",\n        \":simple_memory_arena\",\n        \":string\",\n        \":type_to_tflitetype\",\n        \":util\",\n        \":version\",\n        \"//tensorflow/lite/c:common\",\n        \"//tensorflow/lite/core/api\",\n        \"//tensorflow/lite/delegates/nnapi:nnapi_delegate\",\n        \"//tensorflow/lite/experimental/resource\",\n        \"//tensorflow/lite/nnapi:nnapi_implementation\",\n        \"//tensorflow/lite/schema:schema_fbs\",\n    ],\n)\n\ncc_library(\n    name = \"string_util\",\n    srcs = [\"string_util.cc\"],\n    hdrs = [\"string_util.h\"],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS,\n    deps = [\n        \":string\",\n        \"//tensorflow/lite/c:common\",\n    ],\n)\n\n# Link this library to inject XNNPACK delegate to TFLite runtime automatically\n# by utilizing the weak symbols if they're supported by the platform.\ncc_library(\n    name = \"tflite_with_xnnpack\",\n    srcs = [\"tflite_with_xnnpack.cc\"],\n    copts = tflite_copts() + TFLITE_DEFAULT_COPTS,\n    linkstatic = True,\n    deps = [\n        \"//tensorflow/lite/c:common\",\n        \"//tensorflow/lite/delegates/xnnpack:xnnpack_delegate\",\n    ],\n    alwayslink = 1,\n)\n\n# Enables applying XNNPACK delegate for float models in TFLite runtime.\n# WARNING: This build flag is experimental and subject to change.\nconfig_setting(\n    name = \"tflite_with_xnnpack_explicit_true\",\n    values = {\"define\": \"tflite_with_xnnpack=true\"},\n)\n\nconfig_setting(\n    name = \"tflite_with_xnnpack_explicit_false\",\n    values = {\"define\": \"tflite_with_xnnpack=false\"},\n)\n\ncc_library(\n    name = \"tflite_with_xnnpack_enabled\",\n    defines = [\"TFLITE_BUILD_WITH_XNNPACK_DELEGATE\"],\n    visibility = [\"//visibility:private\"],\n    deps = [\n        \"//tensorflow/lite/delegates/xnnpack:xnnpack_delegate\",\n    ],\n)\n\ncc_library(\n    name = \"tflite_with_xnnpack_default\",\n    compatible_with = get_compatible_with_portable(),\n    visibility = [\"//visibility:private\"],\n    # TODO(b/151246885): put \":tflite_with_xnnpack_enabled\" to macos/windows\n    # once we have a good testing coverage on these two platforms.\n    deps = select({\n        \"//tensorflow:macos\": [],\n        \"//tensorflow:windows\": [],\n        \"//conditions:default\": [],\n    }),\n)\n\ncc_library(\n    name = \"tflite_with_xnnpack_optional\",\n    srcs = [\"tflite_with_xnnpack_optional.cc\"],\n    hdrs = [\n        \"core/macros.h\",\n        \"tflite_with_xnnpack_optional.h\",\n    ],\n    compatible_with = get_compatible_with_portable(),\n    copts = tflite_copts() + TFLITE_DEFAULT_COPTS,\n    deps = [\n        \"//tensorflow/lite/c:common\",\n    ] + select({\n        \":tflite_with_xnnpack_explicit_true\": [\n            \"//tensorflow/lite/delegates/xnnpack:xnnpack_delegate_hdrs_only\",\n            \":tflite_with_xnnpack_enabled\",\n        ],\n        \":tflite_with_xnnpack_explicit_false\": [],\n        \"//conditions:default\": [\n            \"//tensorflow/lite/delegates/xnnpack:xnnpack_delegate_hdrs_only\",\n            \":tflite_with_xnnpack_default\",\n        ],\n    }),\n)\n\ncc_test(\n    name = \"string_util_test\",\n    size = \"small\",\n    srcs = [\"string_util_test.cc\"],\n    features = [\"-dynamic_link_test_srcs\"],  # see go/dynamic_link_test_srcs\n    tags = [\n        \"tflite_not_portable_ios\",  # TODO(b/117786830)\n    ],\n    deps = [\n        \":framework\",\n        \":string_util\",\n        \"//tensorflow/lite/c:common\",\n        \"//tensorflow/lite/testing:util\",\n        \"@com_google_googletest//:gtest\",\n    ],\n)\n\n# Test main interpreter\ncc_test(\n    name = \"interpreter_test\",\n    size = \"small\",\n    srcs = [\n        \"interpreter_test.cc\",\n    ],\n    features = [\"-dynamic_link_test_srcs\"],  # see go/dynamic_link_test_srcs\n    tags = [\n        \"tflite_not_portable_ios\",  # TODO(b/117786830)\n        \"tflite_smoke_test\",\n    ],\n    deps = [\n        \":builtin_op_data\",\n        \":external_cpu_backend_context\",\n        \":framework\",\n        \":string_util\",\n        \":util\",\n        \":version\",\n        \"//tensorflow/lite/core/api\",\n        \"//tensorflow/lite/kernels:builtin_ops\",\n        \"//tensorflow/lite/kernels:cpu_backend_context\",\n        \"//tensorflow/lite/kernels:kernel_util\",\n        \"//tensorflow/lite/kernels/internal:compatibility\",\n        \"//tensorflow/lite/schema:schema_fbs\",\n        \"//tensorflow/lite/testing:util\",\n        \"//third_party/eigen3\",\n        \"@com_google_googletest//:gtest\",\n    ],\n)\n\n# Test graph utils\ncc_test(\n    name = \"graph_info_test\",\n    size = \"small\",\n    srcs = [\"graph_info_test.cc\"],\n    features = [\"-dynamic_link_test_srcs\"],  # see go/dynamic_link_test_srcs\n    tags = [\n        \"tflite_not_portable_ios\",  # TODO(b/117786830)\n    ],\n    deps = [\n        \":framework\",\n        \"//tensorflow/lite/testing:util\",\n        \"@com_google_googletest//:gtest\",\n    ],\n)\n\n# Test arena allocator\ncc_test(\n    name = \"simple_memory_arena_test\",\n    size = \"small\",\n    srcs = [\"simple_memory_arena_test.cc\"],\n    features = [\"-dynamic_link_test_srcs\"],  # see go/dynamic_link_test_srcs\n    tags = [\n        \"tflite_not_portable_ios\",  # TODO(b/117786830)\n    ],\n    deps = [\n        \":simple_memory_arena\",\n        \"//tensorflow/core:tflite_portable_logging\",\n        \"//tensorflow/lite/testing:util\",\n        \"@com_google_googletest//:gtest\",\n    ],\n)\n\n# Test model framework.\ncc_test(\n    name = \"model_test\",\n    size = \"small\",\n    srcs = [\"model_test.cc\"],\n    data = [\n        \"testdata/0_subgraphs.bin\",\n        \"testdata/2_subgraphs.bin\",\n        \"testdata/add_shared_tensors.bin\",\n        \"testdata/empty_model.bin\",\n        \"testdata/multi_add_flex.bin\",\n        \"testdata/sparse_tensor.bin\",\n        \"testdata/test_min_runtime.bin\",\n        \"testdata/test_model.bin\",\n        \"testdata/test_model_broken.bin\",\n    ],\n    tags = [\n        \"tflite_not_portable\",\n        \"tflite_smoke_test\",\n    ],\n    deps = [\n        \":framework\",\n        \"//tensorflow/lite/core/api\",\n        \"//tensorflow/lite/kernels:builtin_ops\",\n        \"//tensorflow/lite/testing:util\",\n        \"@com_google_googletest//:gtest\",\n    ],\n)\n\n# Test model framework with the flex library linked into the target.\ntf_cc_test(\n    name = \"model_flex_test\",\n    size = \"small\",\n    srcs = [\"model_flex_test.cc\"],\n    data = [\n        \"testdata/multi_add_flex.bin\",\n    ],\n    tags = [\n        \"no_gpu\",  # GPU + flex is not officially supported.\n        \"no_windows\",  # TODO(b/116667551): No weak symbols with MSVC.\n        \"tflite_not_portable_android\",\n        \"tflite_not_portable_ios\",\n    ],\n    deps = [\n        \":framework\",\n        \"//tensorflow/lite/core/api\",\n        \"//tensorflow/lite/delegates/flex:delegate\",\n        \"//tensorflow/lite/kernels:builtin_ops\",\n        \"//tensorflow/lite/testing:util\",\n        \"@com_google_googletest//:gtest\",\n    ],\n)\n\n# Test model framework with the XNNPACK delegate.\ncc_test(\n    name = \"model_xnnpack_test\",\n    size = \"small\",\n    srcs = [\n        \"model_xnnpack_test.cc\",\n    ],\n    data = [\n        \"testdata/multi_add.bin\",\n    ],\n    tags = [\n        \"no_windows\",  # No weak symbols with MSVC.\n        \"tflite_not_portable_android\",\n        \"tflite_not_portable_ios\",\n        \"tflite_smoke_test\",\n    ],\n    deps = [\n        \":framework\",\n        \":tflite_with_xnnpack\",\n        \":util\",\n        \"//tensorflow/lite/c:common\",\n        \"//tensorflow/lite/kernels:builtin_ops\",\n        \"@com_google_googletest//:gtest_main\",\n    ],\n)\n\n# Test OpResolver.\ncc_test(\n    name = \"mutable_op_resolver_test\",\n    size = \"small\",\n    srcs = [\"mutable_op_resolver_test.cc\"],\n    features = [\"-dynamic_link_test_srcs\"],  # see go/dynamic_link_test_srcs\n    tags = [\n        \"tflite_not_portable_ios\",  # TODO(b/117786830)\n    ],\n    deps = [\n        \":framework\",\n        \"//tensorflow/lite/testing:util\",\n        \"@com_google_googletest//:gtest\",\n    ],\n)\n\ncc_library(\n    name = \"util\",\n    srcs = [\"util.cc\"],\n    hdrs = [\"util.h\"],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS + tflite_copts(),\n    deps = [\n        \":kernel_api\",\n        \"//tensorflow/lite/c:common\",\n        \"//tensorflow/lite/schema:schema_fbs\",\n    ],\n)\n\ncc_test(\n    name = \"util_test\",\n    size = \"small\",\n    srcs = [\"util_test.cc\"],\n    features = [\"-dynamic_link_test_srcs\"],  # see go/dynamic_link_test_srcs\n    tags = [\n        \"tflite_not_portable_ios\",  # TODO(b/117786830)\n    ],\n    deps = [\n        \":util\",\n        \"//tensorflow/lite/c:common\",\n        \"//tensorflow/lite/schema:schema_fbs\",\n        \"@com_google_googletest//:gtest\",\n    ],\n)\n\ncc_library(\n    name = \"minimal_logging\",\n    srcs = [\n        \"minimal_logging.cc\",\n    ] + select({\n        \"//tensorflow:android\": [\n            \"minimal_logging_android.cc\",\n        ],\n        \"//tensorflow:ios\": [\n            \"minimal_logging_ios.cc\",\n        ],\n        \"//tensorflow:macos\": [\n            \"minimal_logging_default.cc\",\n        ],\n        \"//conditions:default\": [\n            \"minimal_logging_default.cc\",\n        ],\n    }),\n    hdrs = [\"minimal_logging.h\"],\n    compatible_with = get_compatible_with_portable(),\n    copts = TFLITE_DEFAULT_COPTS + tflite_copts(),\n    linkopts = select({\n        \"//tensorflow:android\": [\"-llog\"],\n        \"//conditions:default\": [],\n    }),\n    visibility = [\n        \"//tensorflow/lite:__subpackages__\",\n    ],\n)\n\ncc_library(\n    name = \"type_to_tflitetype\",\n    hdrs = [\n        \"portable_type_to_tflitetype.h\",\n    ] + select({\n        \":tf_lite_static_memory\": [],\n        \"//conditions:default\": [\n            \"type_to_tflitetype.h\",\n        ],\n    }),\n    compatible_with = get_compatible_with_portable(),\n    deps = [\"//tensorflow/lite/c:common\"],\n)\n\ncc_test(\n    name = \"type_to_tflitetype_test\",\n    size = \"small\",\n    srcs = [\"type_to_tflitetype_test.cc\"],\n    deps = [\n        \":type_to_tflitetype\",\n        \"@com_google_googletest//:gtest_main\",\n    ],\n)\n\ncc_test(\n    name = \"minimal_logging_test\",\n    size = \"small\",\n    srcs = [\"minimal_logging_test.cc\"],\n    tags = [\n        \"tflite_not_portable_ios\",  # TODO(b/117786830)\n    ],\n    deps = [\n        \":minimal_logging\",\n        \"@com_google_googletest//:gtest\",\n    ],\n)\n\ncc_library(\n    name = \"shared_library\",\n    hdrs = [\"shared_library.h\"],\n    compatible_with = get_compatible_with_portable(),\n    linkopts = if_not_windows([\"-ldl\"]),\n)\n\ncc_library(\n    name = \"macros\",\n    hdrs = [\"core/macros.h\"],\n)\n\n# Shared lib target for convenience, pulls in the core runtime and builtin ops.\n# Note: This target is not yet finalized, and the exact set of exported (C/C++)\n# APIs is subject to change. The output library name is platform dependent:\n#   - Linux/Android: `libtensorflowlite.so`\n#   - Mac: `libtensorflowlite.dylib`\n#   - Windows: `tensorflowlite.dll`\ntflite_cc_shared_object(\n    name = \"tensorflowlite\",\n    # Until we have more granular symbol export for the C++ API on Windows,\n    # export all symbols.\n    features = [\"windows_export_all_symbols\"],\n    linkopts = select({\n        \"//tensorflow:macos\": [\n            \"-Wl,-exported_symbols_list,$(location //tensorflow/lite:tflite_exported_symbols.lds)\",\n        ],\n        \"//tensorflow:windows\": [],\n        \"//conditions:default\": [\n            \"-Wl,-z,defs\",\n            \"-Wl,--version-script,$(location //tensorflow/lite:tflite_version_script.lds)\",\n        ],\n    }),\n    per_os_targets = True,\n    deps = [\n        \":framework\",\n        \":tflite_exported_symbols.lds\",\n        \":tflite_version_script.lds\",\n        \"//tensorflow/lite/kernels:builtin_ops_all_linked\",\n    ],\n)\n\ntflite_portable_test_suite()"