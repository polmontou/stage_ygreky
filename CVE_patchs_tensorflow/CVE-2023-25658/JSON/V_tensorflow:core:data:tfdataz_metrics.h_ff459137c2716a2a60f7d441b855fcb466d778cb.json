"/* Copyright 2022 The TensorFlow Authors. All Rights Reserved.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n==============================================================================*/\n#ifndef TENSORFLOW_CORE_DATA_TFDATAZ_METRICS_H_\n#define TENSORFLOW_CORE_DATA_TFDATAZ_METRICS_H_\n\n#include <cstdint>\n#include <deque>\n#include <memory>\n#include <string>\n#include <unordered_map>\n#include <utility>\n#include <vector>\n\n#include \"absl/container/flat_hash_set.h\"\n#include \"absl/time/time.h\"\n#include \"tensorflow/core/platform/env.h\"\n#include \"tensorflow/core/platform/mutex.h\"\n#include \"tensorflow/core/platform/thread_annotations.h\"\n\nnamespace tensorflow {\nnamespace data {\n\n// Calculates the approximate average latency for past 1, 5 and 60 minutes.\n// The implementation uses ring buffers to maintain the cumulative latency\n// values and count for the past 60 minutes.\nclass ApproximateLatencyEstimator {\n public:\n  enum class Duration {\n    kMinute = 1,\n    kFiveMinutes = 5,\n    kSixtyMinutes = 60,\n  };\n\n  explicit ApproximateLatencyEstimator(const Env& env);\n\n  // Records the latency with the current timestamp.\n  void AddLatency(int64_t latency_usec);\n\n  // Returns the average latency for the duration (1,5 and 60 minutes)\n  // specified.\n  absl::Duration GetAverageLatency(Duration duration);\n\n private:\n  static constexpr int64_t kSecondsPerMinute = 60;\n  static constexpr int64_t kMinutesPerHour = 60;\n  static constexpr int64_t kSlots = kMinutesPerHour;\n\n  // Updates the latency value and count ring buffers with the latest cumulative\n  // value and count. Resets the entire ring buffer with the last cumulative\n  // values stored if the elapsed time duration is greater than 60 minutes.\n  void UpdateRingBuffer() TF_LOCKS_EXCLUDED(mu_);\n  // Moves the `next_slot_` to the next index in the ring buffer.\n  void IncrementNextSlot() TF_EXCLUSIVE_LOCKS_REQUIRED(mu_);\n  // Returns the slot index which is behind the current slot in ring buffer by\n  // `steps` indices.\n  int PrevSlot(int steps) TF_EXCLUSIVE_LOCKS_REQUIRED(mu_);\n\n  const Env& env_;\n\n  // The time when the ring buffer was last updated.\n  int64_t last_updated_time_mins_ TF_GUARDED_BY(mu_);\n\n  mutex mu_;\n\n  // Counters storing the cumulative sums of latency values and counts recorded\n  // so far.\n  int64_t latency_value_counter_ TF_GUARDED_BY(mu_);\n  int64_t latency_count_counter_ TF_GUARDED_BY(mu_);\n\n  // Next slot in the ring buffer.\n  int next_slot_ TF_GUARDED_BY(mu_);\n\n  // Ring buffer storing the cumulative sum of latency values and counts for the\n  // last 60 minutes.\n  int64_t latency_value_[kSlots] TF_GUARDED_BY(mu_);\n  int64_t latency_count_[kSlots] TF_GUARDED_BY(mu_);\n};\n\n// Collects and exports the tf.data performance metrics to /tfdataz.\nclass TfDatazMetricsCollector {\n public:\n  // Constructs a `TfDatazMetricsCollector`.\n  // We only collect metrics for CPU devices. This is a heuristic to avoid\n  // collecting metrics for device-side iterators created by the multi-device\n  // iterator mechanism.\n  explicit TfDatazMetricsCollector(const Env& env);\n\n  // Records `GetNext` call latency.\n  void RecordGetNextLatency(int64_t get_next_latency_usec);\n\n  // Returns the average `GetNext` latency for past 1 minute.\n  absl::Duration GetAverageLatencyForLastOneMinute();\n\n  // Returns the average `GetNext` latency for past 5 minutes.\n  absl::Duration GetAverageLatencyForLastFiveMinutes();\n\n  // Returns the average `GetNext` latency for past 60 minutes.\n  absl::Duration GetAverageLatencyForLastSixtyMinutes();\n\n private:\n  ApproximateLatencyEstimator latency_estimator_;\n};\n\n// Thread-safe global registry for the /tfdataz metrics. All callers to\n// `TfDatazMetricsRegistry` use the same instance to register and deregister\n// iterator's `TfDatazMetricsCollector`.\nclass TfDatazMetricsRegistry {\n public:\n  // Registers the iterator specific `TfDatazMetricsCollector` in the global\n  // TfDatazMetricsRegistry.\n  static void Register(std::shared_ptr<TfDatazMetricsCollector> collector);\n\n  // Deregisters the iterator specific `TfDatazMetricsCollector` from the global\n  // TfDatazMetricsRegistry.\n  static void Deregister(std::shared_ptr<TfDatazMetricsCollector> collector);\n\n  // Returns all the registered `TfDatazMetricsCollector`s.\n  static absl::flat_hash_set<std::shared_ptr<TfDatazMetricsCollector>>\n  GetIteratorMetricCollectors();\n};\n\n}  // namespace data\n}  // namespace tensorflow\n\n#endif  // TENSORFLOW_CORE_DATA_TFDATAZ_METRICS_H_"